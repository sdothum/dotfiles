#!/usr/bin/dash
# sdothum - 2016 (c) wtfpl

# Dev
# ══════════════════════════════════════════════════════════════════════════════

# ............................................................. Print code block

usage() { usage: "$(basename $0) case | do | if | [<begin> [<end>]] [<file>]"; exit 1; }

# for shell script development

lines=4  # nuxber of lines after match

while [ "$1" ] ;do
	case $1 in
		help) usage ;;
		case) type=$1; begin='case .* in' ;;
		do  ) type=$1; begin='(for|while) .*; *do' ;;
		if  ) type=$1; begin='if .*; *then' ;;

		*   )
			[ -e $1 ] && { file=$1; break; }
			[ "$begin" ] && { type=blk; end="$1"; } || { type=stmt; begin="$1"; } ;;
	esac
	shift
done

filter() {
	case $type in
		case) sed -nr '/case .* in/,/\besac\b/p' ;;
		do  ) sed -nr '/(for|while) .*; *do/,/\bdone\b/p' ;;
		if  ) sed -nr '/if .*; *then/,/\bfi\b/p' ;;
		blk ) sed -nr "/$begin/,/$end/p" ;;
		stmt) grep -A$lines -E "$begin" ;;
	esac
}

match() {
	# clear; ditto $type $1
	cat $1 | filter | print
	[ $file ] || { ifno "edit $i" || vim -g -f $1; }
}

if [ $file ] ;then
	match $file
else
	for i in $(al "$begin") ;do
		match $i
	done
fi

# vim: set ft=sh: #
