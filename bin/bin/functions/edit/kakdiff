#!/usr/bin/bash
# sdothum - 2016 (c) wtfpl

# Edit
# ══════════════════════════════════════════════════════════════════════════════

# .................................................................. Diff editor

usage() { usage: "$(basename $0) [-b] <file> <reference>"; exit 1; }

KAK=/usr/bin/kak
[ -e /usr/local/bin/kak ] && KAK=/usr/local/bin/kak
[ "$1" = '-b' ] && { B=-b; BOPT=--show-no-spaces; shift; }
COLORDIFF=colordiff  # SEE: ~/.colordiffrc

if exists icdiff ;then
	if [ $(wc -L "$1" | cut -d' ' -f1) -le 1024 ] ;then  # BUG: icdiff line width limit
		IC=ic
		ICOPT="--line-numbers --truncate --tabsize=3 --cols=$(tput cols) $BOPT --color-map=add:red_bold,change:red_bold,subtract:red_bold,description:blue_bold,line-numbers:black_bold,separator:black_bold"  # BUG: cols calculation required (icdiff width detection not working)
		COLORDIFF=cat
	fi
fi
[ -e "$2" ] || usage

export DIFF=/tmp/kakdiff:${1##*/}.diff  # NOTE: export DIFF to nop bundle kakoune-cd SEE: kakrc
trap "rm $DIFF" EXIT
diff $B -u $1 $2 >$DIFF

[ $? -eq 0 ] && exit 0  # SEE: dirdiff
ditto diff "$1"

${IC}diff ${ICOPT} "$1" "$2" | $COLORDIFF | pager
ifdiff "edit ${file}"
case $? in
	0 ) exit 1 ;;
	1 ) $KAK $DIFF $1 $2; exit 2 ;;  # SEE: dirdiff cycle control
esac

ifdiff 'copy'
case $? in
	2 ) exit 2     ;;
	3 ) copy $1 $2 ;;
	4 ) copy $2 $1 ;;
	5 ) swap $1 $2 ;;
esac

# kak: filetype=sh
