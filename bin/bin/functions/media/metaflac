#!/usr/bin/bash
# sdothum - 2016 (c) wtfpl

# Media
# ══════════════════════════════════════════════════════════════════════════════

# ................................................................. FLAC editing

usage() { echo "$(basename $0) [ls | rm <tag>*]
> [-d] [album | albumartist | artist | date | genre] <string> | /<regex>
> [-d] title /<regex>, against all tracks
> [-d] tracknumber <from>, increment all tracks starting <from>
> [-d] [<name>.flac | <track>] <title> | /<regex>
>          where, track  -> ## of flac filename
>                 /regex -> (sed s) /from/to/[<flag>*]
>                 -d or \$debug envar to list set-tag only
>                 -q for no confirmation prompt" | usage:\pipe
	exit 1
} 

METAFLAC=/usr/bin/metaflac
TAGS='@(album|albumartist|artist|date|genre|title|tracknumber)'  # extglob pattern list

[ "$1" = '-d' ] && { debug=true; shift; }
[ "$1" = '-q' ] && { quiet=true; shift; }

confirm()  { [ $debug ] || [ $quiet ] || { ifno 'apply changes' && usage; } }
metadata() { for f in *flac; do ditto track "$f"; $METAFLAC --export-tags-to=- "$f"; done; }
tagcheck() { for i in $@; do metadata | grep -iq "^$i=" || { ditto tag "$i not found"; rcode=1; } ;done; return ${rcode:-0}; }

shopt -s extglob  # SEE: $TAGS
case $1 in
	''          ) quiet=true; set -- 'ls' ;;
	ls          ) quiet=true ;;
	rm          ) tagcheck ${@:2} || usage ;;
	*.flac      ) file=$1 ;;
	[0-9]*      ) file="$(find ./ -maxdepth 1 -name "${1}*.flac")"; [ "$file" ] || usage ;;
	title       ) [ "${2}" = "/${2#?}" ]   || usage ;;
	tracknumber ) TRACK=$(token number $2) || usage ;;  # TRACK unset otherwise SEE: metaflac()
	$TAGS       ) ;;
	*           ) usage ;;
esac
shopt -u extglob

settag() {
	if [ $debug ] ;then
		echo $METAFLAC --set-tag=$1="$2" "$file"
	else
		$METAFLAC --remove-tag=$1 "$file"
		$METAFLAC --set-tag=$1="$2" "$file"
	fi
}

regextag() {
	echo | sed -r "s$2" >/dev/null 2>&1 || { ditto syntax "sed "s$2""; exit; }  # sed sanity check
	if [ $debug ] ;then
		# $METAFLAC --show-tag=$1 "$file"
		ditto $1 "$($METAFLAC --show-tag=$1 "$file" | cut -d= --complement -f1)"
		ditto regex "$($METAFLAC --show-tag=$1 "$file" | cut -d= --complement -f1 | sed -r "s$2")"
	fi
	tag=$($METAFLAC --show-tag=$1 "$file" | cut -d= --complement -f1 | sed -r "s$2")  # NOTE: --complement for LAST field :)
	settag $1 "$tag"
}

metaflac() {
	confirm
	if [ "$file" ] ;then
		${1}tag TITLE "${TRACK:-$3}"    # track specific action
	else
		for file in *.flac ;do
			${1}tag "$2" "${TRACK:-$3}"
			[ $TRACK ] && (( TRACK++ ))  # tracknumbers must increment
		done
	fi
}

case $1 in
	ls ) metadata ;;
	rm ) while [ $2 ] ;do ditto tag "remove $2"; confirm; for i in *flac; do $METAFLAC --remove-tag=$2 "$i"; done; shift; done;;
	*  )
		TAG=$(echo $1 | tr '[:lower:]' '[:upper:]')
		shift
		case "$@" in
			''     ) usage ;;
			/*/*/* ) metaflac regex "$TAG" "$@";;
			/*     ) usage ;;
			*      ) metaflac set "$TAG" "$@";;
		esac
		;;
esac

# kak: filetype=sh
