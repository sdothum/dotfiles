#!/usr/bin/dash
#
# sdothum - 2016 (c) wtfpl

# 2bwm
# ══════════════════════════════════════════════════════════════════════════════

# .................................................................. Window size

TWOBWM_CONFIG=$HOME/.config/2bwm/src/config.h

[ $1 ] && { size=$1; shift; }  # keybind usage

# 2bwm panel geometry
set -- $(grep '^static const uint8_t offsets' $TWOBWM_CONFIG | sed 's/.*[{]//; s/[}].*//; s/,/ /g')
PANEL_HEIGHT=$(( $4 - $2 ))
PANEL_INDENT=$(( $1 * ${indent:-3 / 2} ))  # assumes equal left/right screen margins
shift 4

width=$(query display width)
height=$(query display height)

windowsize() {
	X=$(echo "scale=2\n($width - ($PANEL_INDENT * 2 + $PANEL_HEIGHT * (($2 / $1) - 1))) / ($2 / $1)" | bc | cut -d. -f1)
	Y=$(echo "scale=2\n$height - $PANEL_HEIGHT * ($2 / $1) * ($2 / $1)" | bc | cut -d. -f1)
	# wrs -a $X $Y $(pfw)       # BUG: inconsistent behaviour
	winid=$(xdotool getwindowfocus -f)
	xdotool windowunmap $winid  # unmap / map required to allow key placement to redraw correctly for 1/2 size
	xdotool windowsize --sync $winid $X $Y
	xdotool windowmap --sync $winid
	xdotool key Super+Shift+g   # 2bwm vertical center
}

actions() { echo "1   monocle\n2   1/2\n3   1/3\n4   2/7\n5   1/4\n6   2/9\n7   1/5"; }

if [ $size ] ;then
	case $size in
		1        ) sleep 0.1; xdotool key --delay 100 Super+9 ;;  # allow user keyboard release
		2        ) windowsize 1 2 ;;
		3        ) windowsize 1 3 ;;
		4        ) windowsize 2 7 ;;
		5        ) windowsize 1 4 ;;
		6        ) windowsize 2 9 ;;
		7        ) windowsize 1 5 ;;
	esac
else
	cmd=$(actions | rmenu 'Session' $cmd -no-custom) || exit
	case $cmd in
		*monocle ) xdotool key --delay 100 Super+9 ;;  # remapped in 2bwm/config.h
		*1/2     ) windowsize 1 2 ;;
		*1/3     ) windowsize 1 3 ;;
		*2/7     ) windowsize 2 7 ;;
		*1/4     ) windowsize 1 4 ;;
		*2/9     ) windowsize 2 9 ;;
		*1/5     ) windowsize 1 5 ;;
	esac
fi

# vim: set ft=sh: #
