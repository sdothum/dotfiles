#!/usr/bin/dash
# sdothum - 2016 (c) wtfpl
[ $TRACE ] && CHILD="window/size $@" . $PARENT

# 2bwm
# ══════════════════════════════════════════════════════════════════════════════

# .............................................................. Set window size

# Usage: window size [delay] <height>x<width> | monocle | rotate | <numerator>/<denominator> (fraction :)

X=1024
Y=800
T=2

TWOBWM_CONFIG=$HOME/.config/2bwm/src/config.h
SPANEL=$SESSION/panel   # toggle state
WINFO=$TWOBWM:window

winid=$(xdotool getwindowfocus -f)

save_geometry() { xdotool getwindowgeometry --shell $winid >$WINFO:$winid; }  # for revert

draw() {
	save_geometry
	xdotool windowunmap $1                                   # defer visual refresh
	xdotool windowsize --sync $1 $2 $3
	xdotool windowmap --sync $1
	[ $4 ] || xdotool key Super+Shift+g                      # 2bwm vertical center
}

revert() {
	[ -e $WINFO:$winid ] && eval $(cat $WINFO:$winid) || exit
	draw $winid $WIDTH $HEIGHT revert
	xdotool windowmove $winid $X $Y
}

calc_window() {
	numerator=$1
	denominator=$2
	indent=$(cat $SPANEL)  # see draw panel
	# 2bwm panel geometry
	set -- $(grep '^static const uint8_t offsets' $TWOBWM_CONFIG | sed 's/.*[{]//; s/[}].*//; s/,/ /g')
	PANEL_HEIGHT=$(( $4 - $2 ))
	PANEL_INDENT=$(( $1 * ${indent:-3 / 2} ))  # assumes equal left/right screen margins
	shift 4
	width=$(query display width)
	height=$(query display height)

	X=$(echo "scale=2\n($width - ($PANEL_INDENT * 2 + $PANEL_HEIGHT * (($denominator / $numerator) - 1))) / ($denominator / $numerator)" | bc | cut -d. -f1)
	Y=$(echo "scale=2\n$height - $PANEL_HEIGHT * ($denominator / $numerator) * ($denominator / $numerator)" | bc | cut -d. -f1)
	# wrs -a $X $Y $(pfw)       # BUG: inconsistent behaviour
	winid=$(xdotool getwindowfocus -f)
	draw $winid $X $Y
}

rotate() {
	winid=$(xdotool getwindowfocus -f)
	XY=$(xdotool getwindowgeometry $winid | grep -i 'geometry' | cut -d: -f2)
	draw $winid ${XY#*x} ${XY%x*}
}

monocle() {
	save_geometry
	sleep 0.1                                   # allow user keyboard release
	xdotool key --delay 100 Super+Shift+Ctrl+1  # see 2bwm config.h
}

while [ $1 ] ;do
	case $1 in
		rev* ) revert; exit ;;
		rot* ) rotate; exit ;;
		mon* ) monocle; exit ;;
		*/*  ) calc_window ${1%/*} ${1#*/}; exit ;;
		*x*  ) draw $winid ${1%x*} ${1#*x}; exit ;;
		*    ) delay=$1 ;;
	esac
	shift
done

set_window ${height:-$X} ${width:-$Y}

# vim: set ft=sh: #

